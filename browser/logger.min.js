var _DEFAULTS={url:"/api/log",flushInterval:1e3,isInSampling:!0,samplingRate:100,collectMetrics:!0,logLevels:["log","info","warn","debug","error"],maxAttempts:50};function Logger(){this.buffer=[],this.plugins={},this.url=_DEFAULTS.url,this.flushInterval=_DEFAULTS.flushInterval,this.collectMetrics=_DEFAULTS.collectMetrics,this.logLevels=_DEFAULTS.logLevels,this.maxAttempts=_DEFAULTS.maxAttempts}function sample(t){return 100*Math.random()<t}function intialize(){var e=new Logger;if(window){window.$logger=e;var i=window.onerror;window.onerror=function(){var t=Array.prototype.slice.call(arguments);return e.error(t),!!i&&i.apply(window,t)}}}Logger.prototype.init=function(t){t=t||_DEFAULTS,this.url=t.url||this.url,this.logLevels=t.logLevels||this.logLevels,this.flushInterval=void 0!==t.flushInterval?t.flushInterval:this.flushInterval,this.collectMetrics=void 0!==t.collectMetrics?t.collectMetrics:this.collectMetrics,this.isInSampling=void 0!==t.isInSampling?t.isInSampling:sample(t.samplingRate),this.isSendCritical=void 0!==t.isSendCritical&&t.isSendCritical,this.maxAttempts=void 0!==t.maxAttempts?t.maxAttempts:this.maxAttempts;var r=this;if(r.isInSampling||r.isSendCritical){["log","info","warn","debug","error"].forEach(function(e){var i=console[e];console[e]=function(){var t=Array.prototype.slice.call(arguments);r[e](t),i.apply(console,t)}}),r.flushInterval?r.interval=setInterval(function(){r.flush()},r.flushInterval):window.addEventListener("onpagehide"in window?"pagehide":"beforeunload",function(){r.flush()},!1)}},Logger.prototype.registerPlugin=function(t,e){this.plugins[t]=e},Logger.prototype.metrics=function(){if(window.performance){var t=window.performance,e=t.timing,i=t.navigation;return t.metrics={navType:i.type,rc:i.redirectCount,lt:e.loadEventEnd-e.navigationStart,ct:e.responseEnd-e.requestStart,rt:e.domComplete-e.domLoading},t.metrics}},Logger.prototype.log=function(){this.addToQ("LOG",arguments)},Logger.prototype.info=function(){this.addToQ("INFO",arguments)},Logger.prototype.debug=function(){this.addToQ("DEBUG",arguments)},Logger.prototype.warn=function(){this.addToQ("WARN",arguments)},Logger.prototype.error=function(){var e=[];Array.prototype.slice.call(arguments[0]).forEach(function(t){"object"==typeof t&&t&&t.stack?e.push(t.stack):e.push(t)}),this.addToQ("ERROR",e)},Logger.prototype.clearBuffer=function(t){this.buffer=this.buffer.slice(t)},Logger.prototype.addToQ=function(t,e){if(-1<this.logLevels.indexOf(t.toLowerCase())){var i="Non critical",r="object"==typeof e[0]?e[0]:this.getObj(e[0]);r&&"critical"===r.type?(i=r.desc,delete r.desc,e=JSON.stringify(r),t="CRITICAL"):e=0<e.length&&[].join.call(e," ")||"",(this.isInSampling||this.isSendCritical&&"CRITICAL"===t)&&this.buffer.push({level:t,msg:e,desc:i})}},Logger.prototype.getObj=function(t){try{return JSON.parse(t)}catch(t){}},Logger.prototype.flush=function(){var e=this;if(!(e.buffer.length<1)){0<e.maxAttempts&&(e.maxAttempts=e.maxAttempts-1,0===e.maxAttempts&&clearInterval(e.interval));var t=e.buffer.length,i={logs:e.buffer,isBeaconAPI:!1},r=e.url+(-1===e.url.indexOf("?")?"?":"&")+"desc="+encodeURI(e.buffer.map(function(t){return t.desc}));if(e.collectMetrics&&(i.metrics=e.metrics()),Object.keys(e.plugins).forEach(function(t){e.plugins[t](i)}),navigator&&navigator.sendBeacon){i.isBeaconAPI=!0,navigator.sendBeacon(r,JSON.stringify(i))&&e.clearBuffer(t)}else{var o=new XMLHttpRequest;o.open("POST",r,!0),o.setRequestHeader("Content-Type","text/plain"),o.onreadystatechange=function(){4===o.readyState&&200===o.status&&e.clearBuffer(t)},o.send(JSON.stringify(i))}}},intialize();
