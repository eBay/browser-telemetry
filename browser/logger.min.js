var _DEFAULTS={url:"/api/log",flushInterval:1e3,isInSampling:!0,samplingRate:100,collectMetrics:!0,logLevels:["log","info","warn","debug","error"],maxAttempts:50};function Logger(){this.buffer=[],this.plugins={},this.url=_DEFAULTS.url,this.flushInterval=_DEFAULTS.flushInterval,this.collectMetrics=_DEFAULTS.collectMetrics,this.logLevels=_DEFAULTS.logLevels,this.maxAttempts=_DEFAULTS.maxAttempts}function sample(t){return 100*Math.random()<t}function intialize(){var e=new Logger;if(window){window.$logger=e;var i=window.onerror;window.onerror=function(){var t=Array.prototype.slice.call(arguments);return e.error(t),!!i&&i.apply(window,t)}}}Logger.prototype.init=function(t){t=t||_DEFAULTS,this.url=t.url||this.url,this.logLevels=t.logLevels||this.logLevels,this.flushInterval=void 0!==t.flushInterval?t.flushInterval:this.flushInterval,this.collectMetrics=void 0!==t.collectMetrics?t.collectMetrics:this.collectMetrics,this.isInSampling=void 0!==t.isInSampling?t.isInSampling:sample(t.samplingRate),this.isSendCritical=void 0!==t.isSendCritical&&t.isSendCritical,this.maxAttempts=void 0!==t.maxAttempts?t.maxAttempts:this.maxAttempts;var n=this;if(n.isInSampling||n.isSendCritical){["log","info","warn","debug","error"].forEach(function(e){var i=console[e];console[e]=function(){var t=Array.prototype.slice.call(arguments);n[e](t),i.apply(console,t)}}),n.flushInterval?n.interval=setInterval(function(){n.flush()},n.flushInterval):window.addEventListener("onpagehide"in window?"pagehide":"beforeunload",function(){n.flush()},!1)}},Logger.prototype.registerPlugin=function(t,e){this.plugins[t]=e},Logger.prototype.metrics=function(){if(window.performance){var t=window.performance,e=t.timing,i=t.navigation;return{navType:i.type,rc:i.redirectCount,lt:e.loadEventEnd-e.navigationStart,ct:e.responseEnd-e.requestStart,rt:e.domComplete-e.domLoading}}},Logger.prototype.log=function(){this.addToQ("LOG",arguments)},Logger.prototype.info=function(){this.addToQ("INFO",arguments)},Logger.prototype.debug=function(){this.addToQ("DEBUG",arguments)},Logger.prototype.warn=function(){this.addToQ("WARN",arguments)},Logger.prototype.error=function(){var e=[];Array.prototype.slice.call(arguments[0]).forEach(function(t){"object"==typeof t&&t&&t.stack?e.push(t.stack):e.push(t)}),this.addToQ("ERROR",e)},Logger.prototype.clearBuffer=function(t){this.buffer=this.buffer.slice(t)},Logger.prototype.addToQ=function(t,e){if(-1<this.logLevels.indexOf(t.toLowerCase())){var i=0<e.length&&[].join.call(e," ")||"";(this.isInSampling||this.isSendCritical&&-1<i.indexOf('"type":"critical"'))&&this.buffer.push({level:t,msg:i,desc:this.getDesc(i)})}},Logger.prototype.getDesc=function(t){var e="Non critical";if(-1<t.indexOf("{")&&-1<t.indexOf("}"))try{var i=JSON.parse(t.substring(t.indexOf("{"),t.indexOf("}")+1));e=i&&i.desc}catch(t){}return e},Logger.prototype.flush=function(){var e=this;if(!(e.buffer.length<1)){0<e.maxAttempts&&(e.maxAttempts=e.maxAttempts-1,0===e.maxAttempts&&clearInterval(e.interval));var t=e.buffer.length,i={metrics:e.metrics(),logs:e.buffer,isBeaconAPI:!1},n=e.url+(-1===e.url.indexOf("?")?"?":"&")+"desc="+encodeURI(e.buffer.map(function(t){return t.desc}));if(Object.keys(e.plugins).forEach(function(t){e.plugins[t](i)}),navigator&&navigator.sendBeacon){i.isBeaconAPI=!0,navigator.sendBeacon(n,JSON.stringify(i))&&e.clearBuffer(t)}else{var r=new XMLHttpRequest;r.open("POST",n,!0),r.setRequestHeader("Content-Type","text/plain"),r.onreadystatechange=function(){4===r.readyState&&200===r.status&&e.clearBuffer(t)},r.send(JSON.stringify(i))}}},intialize();
